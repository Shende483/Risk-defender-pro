pipeline {
  agent any

  environment {
    FRONTEND_DIR = '/frontend'
    BACKEND_DIR = '/backend'  
    FROTEND_PORT = '3030'
    BACKEND_PORT = '3040'
  }

  stages {
    stage('Build Frontend') {
      steps {
        dir("${env.FRONTEND_DIR}") {
          sh '''
            echo "‚û°Ô∏è Installing frontend dependencies"
            npm install

            echo "üõ†Ô∏è Building frontend"
            npm build

            echo "‚ôªÔ∏è Restarting frontend with PM2"
            pm2 delete frontend || true
            pm2 start "npx serve -s dist -l $FRONTEND_PORT" --name frontend
          '''
        }
      }
    }

    stage('Build Backend') {
      steps {
        dir("${env.BACKEND_DIR}") {
          sh '''
            echo "‚û°Ô∏è Installing backend dependencies"
            npm install

            echo "üõ†Ô∏è Building backend"
            npm build

            echo "‚ôªÔ∏è Restarting backend with PM2"
            pm2 delete backend || true
            pm2 start dist/main.js --name backend
          '''
        }
      }
    }
  }

  post {
    success {
      echo '‚úÖ Local deployment complete!'
    }
    failure {
      echo '‚ùå Something went wrong.'
    }
  }
}
